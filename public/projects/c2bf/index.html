<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>C? Rewrite it in Brainfuck. | iacgm</title>
<meta name="keywords" content="">
<meta name="description" content="C2BF: A C-to-Brainfuck Compiler.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/projects/c2bf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b489a6d73b9d5f542e10296b5fbfe24c07a73618c7ca7efba908fadedc6200f9.css" integrity="sha256-tImm1zudX1QuEClrX7/iTAenNhjHyn77qQj63txiAPk=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/projects/c2bf/">
<link rel="alternate" hreflang="es" href="http://localhost:1313/es/projects/c2bf/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '1864484');
</script>


</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="iacgm (Alt + H)">iacgm</a>
            <div class="logo-switches">
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/es/" title="Español"
                            aria-label="Español">Es</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/index.xml" title="RSS">
                    <span>RSS</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      C? Rewrite it in Brainfuck.
    </h1>
    <div class="post-meta"><span title='2025-10-01 00:00:00 +0000 UTC'>October 1, 2025</span>&nbsp;·&nbsp;13 min&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/es/projects/c2bf/">Es</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#doing-things-worst" aria-label="Doing Things Worst">Doing Things Worst</a></li>
                <li>
                    <a href="#brainfuck-semantics" aria-label="Brainfuck Semantics">Brainfuck Semantics</a></li>
                <li>
                    <a href="#compiler-primer" aria-label="Compiler Primer">Compiler Primer</a><ul>
                        
                <li>
                    <a href="#lexing--parsing" aria-label="Lexing &amp; Parsing">Lexing &amp; Parsing</a></li>
                <li>
                    <a href="#ir-generation" aria-label="IR Generation">IR Generation</a></li>
                <li>
                    <a href="#translation-into-brainfuck" aria-label="Translation into Brainfuck">Translation into Brainfuck</a></li>
                <li>
                    <a href="#peephole-optimization" aria-label="Peephole optimization">Peephole optimization</a></li></ul>
                </li>
                <li>
                    <a href="#limitations" aria-label="Limitations">Limitations</a></li>
                <li>
                    <a href="#similar-projects" aria-label="Similar Projects">Similar Projects</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="doing-things-worst">Doing Things Worst<a hidden class="anchor" aria-hidden="true" href="#doing-things-worst">#</a></h2>
<p>People always seem to want to do things well, and when they fail, they tend to blame their tools. So it should come as no surprise that programmers, being somewhat similar to people (and being generally bad at what they do), have a long tradition of growing near-religious zeal for editors, paradigms, code styles, and, of course, programming languages. The bickering never ends, and whatever one person preaches, another <a href="https://en.wikipedia.org/wiki/Considered_harmful">considers harmful</a>.</p>
<p>&ldquo;<em>Static typing just gets in the way</em>&rdquo;, says one voice, &ldquo;<em>Python lets me just code.</em>&rdquo;</p>
<p>&ldquo;<em>The borrow checker really isn&rsquo;t <strong>that</strong> bad once you get used to it</em>&rdquo;, responds another, whose T-shirt reads &ldquo;Rewrite it in Rust&rdquo;.</p>
<p>&ldquo;<em>Have fun with your loops and mutable state</em>&rdquo;, snickers a third, &ldquo;<em>get back to me when you learn what a monad is.</em>&rdquo;</p>
<p>It is exactly how Boris Marshalov described Congress: &ldquo;A man gets up to speak and says nothing. Nobody listens—and then everybody disagrees.&rdquo;</p>
<p>But then, miraculously, from the heavens above, we hear the wise, booming voices of <a href="https://en.wikipedia.org/wiki/Church%E2%80%93Turing_thesis">Church and Turing</a> in unison, bringing clarity through the noise: &ldquo;It simply does not matter&rdquo;, they say, &ldquo;In good hands, they are all equivalent.&rdquo;</p>
<p>But what if you&rsquo;re not the sort of person who wants to do things well? What if you&rsquo;re the sort of person who wants to things bad? What if you want to do things <strong><em>worst</em></strong>?</p>
<p>In that case, you might have something in common with Urban Müller, who in 1993<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, presumably unable to accept the Church-Turing doctrine, created Brainfuck, a language so heinous that no other name could do it justice. With only 8 instructions and with no support for variables, functions, random access memory, datatypes, fractional arithmetic, memory allocation, or any conventional control flow (!), surely <em>this</em> abomination could not be compared to (say) C, the digital world&rsquo;s lingua franca, used on damn near every device of the last half-century.</p>
<p>Hello world in Brainfuck, for the uninitiated, reads as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-brainfuck" data-lang="brainfuck"><span style="display:flex;"><span>++++++++<span style="color:#66d9ef">[</span>&gt;++++<span style="color:#66d9ef">[</span>&gt;++&gt;+++&gt;+++&gt;+&lt;&lt;&lt;&lt;-<span style="color:#66d9ef">]</span>&gt;+&gt;+&gt;-&gt;&gt;+<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;-<span style="color:#66d9ef">]</span>&gt;&gt;<span style="color:#f92672">.</span>&gt;---<span style="color:#f92672">.</span>+++++++<span style="color:#f92672">..</span>+++<span style="color:#f92672">.</span>&gt;&gt;<span style="color:#f92672">.</span>&lt;-<span style="color:#f92672">.</span>&lt;<span style="color:#f92672">.</span>+++<span style="color:#f92672">.</span>------<span style="color:#f92672">.</span>--------<span style="color:#f92672">.</span>&gt;&gt;+<span style="color:#f92672">.</span>&gt;++<span style="color:#f92672">.</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>Over the last 30 years, Brainfuck has become a sort of running joke for programmers. They like to point and gawk and say, with mysticism and awe: &ldquo;<em>Brainfuck may <strong>look</strong> like a mess, but it&rsquo;s Turing Complete: you can program anything you want in Brainfuck.</em>&rdquo; But you can&rsquo;t program anything you want in Brainfuck, because Brainfuck is <strong>hard</strong>, and you&rsquo;re not that smart.</p>
<p>But <em><strong>I</strong></em> can.</p>
<p><em><strong>I</strong></em> can make just about anything I want in Brainfuck. For instance, take <a href="/donut.bf">this recent Brainfuck creation of mine</a>, which displays an animation of a spinning donut:</p>
<p><img alt="ASCII Donut" loading="lazy" src="/donut.png#center"></p>
<p>If this looks familiar, it&rsquo;s because it&rsquo;s a (slightly modified) version of Andy Sloane&rsquo;s famous C program, <a href="https://www.a1k0n.net/2011/07/20/donut-math.html">donut.c</a>, translated into Brainfuck.</p>
<p>No, I did not write all 125,489 instructions of this myself. Instead, I spent 6 weeks writing a <a href="https://github.com/iacgm/c2bf">C-to-Brainfuck compiler</a>, and then modifying donut.c to use extra-low-precision fixed-point arithmetic.</p>
<p>My compiler supports almost all of C&rsquo;s core features, including:</p>
<ul>
<li>integer arithmetic</li>
<li>local and global variables</li>
<li>loops &amp; if-statements</li>
<li>arrays</li>
<li>functions (&amp; recursion)</li>
<li>pointers</li>
<li>function pointers (!)</li>
</ul>
<p>Here&rsquo;s how I did it.</p>
<h2 id="brainfuck-semantics">Brainfuck Semantics<a hidden class="anchor" aria-hidden="true" href="#brainfuck-semantics">#</a></h2>
<p>Before we discuss the compiler itself, it&rsquo;s worth going over Brainfuck&rsquo;s semantics.</p>
<p>We start with an infinite tape of cells, each containing the number zero. We have a tape head pointing at the first of these. Also, we have eight instructions, each with its own symbol:</p>
<ol>
<li><code>+</code>: Increment the cell under the tape head.</li>
<li><code>-</code>: Decrement the cell under the tape head.</li>
<li><code>&gt;</code>: Move the tape head right.</li>
<li><code>&lt;</code>: Move the tape head left.</li>
<li><code>,</code>: Store the next character from the input into the cell under the tape head.</li>
<li><code>.</code>: Output the value stored in the cell under the tape head.</li>
<li><code>[</code>: If the tape head points to a zero, jump to the corresponding <code>]</code>.</li>
<li><code>]</code>: If the tape head does <strong>not</strong> point to a zero, jump to the corresponding <code>[</code>.</li>
</ol>
<p>Essentially, <code>[</code>/<code>]</code> blocks act as <code>while-non-zero</code> loops.</p>
<p>That&rsquo;s it. Really.</p>
<h2 id="compiler-primer">Compiler Primer<a hidden class="anchor" aria-hidden="true" href="#compiler-primer">#</a></h2>
<p>This compiler is not really all that different from any other, and so is a good basis for learning the basics of compilers in general. All a compiler does is translate one language into another, with some intermediate steps. This is done in a series of translation passes, each taking us slightly further along the path from the source code to the target language. In my compiler, the stages are:</p>
<ol>
<li><strong>Lexing</strong>: This step converts a stream of characters into <strong>tokens</strong>. That is, it splits our code into keywords, identifiers, symbols, etc&hellip;</li>
<li><strong>Parsing</strong>: This step converts a stream of tokens into an <strong>abstract syntax tree</strong> (AST). That is, it splits our code into constructs: expressions, statements, definitions, etc&hellip;</li>
<li><strong>IR Code Generation</strong>: At this step, we convert our AST into an <strong>intermediate representation</strong> (IR). That is, a language that somehow bridges the gap between C and Brainfuck. It should be something easy to translate both into and out of.</li>
<li><strong>BF Code Generation</strong>: At this step, we translate each IR instruction into Brainfuck.</li>
<li><strong>Peephole Optimization</strong>: This step is not really needed, but in order to acheive reasonable execution speeds, we will need to make our Brainfuck interpreter recognize certain patterns common in Brainfuck which can be sped up, or even skipped entirely.</li>
</ol>
<h3 id="lexing--parsing">Lexing &amp; Parsing<a hidden class="anchor" aria-hidden="true" href="#lexing--parsing">#</a></h3>
<p>This is, more-or-less, a solved problem. This is the one part of this project where I made use of an external library, <a href="https://pest.rs/">Pest</a>. This allows us to specify our grammar (in this case, a slightly modified <a href="https://www.quut.com/c/ANSI-C-grammar-l-1999.html">C99 grammar</a><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>) in something more like <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form">Backus-Naur Form</a>. For example:</p>
<pre tabindex="0"><code>if_stmt = { &#34;if&#34; ~ &#34;(&#34; ~ expr ~ &#34;)&#34; ~ stmt ~ (&#34;else&#34; ~ stmt)? }
</code></pre><p>Once Pest has constructed a parse tree, we can straightforwardly construct our AST. For example, our if-statement struct looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Stmt</span> {
</span></span><span style="display:flex;"><span>  IfStmt(Expr, Box<span style="color:#f92672">&lt;</span>Stmt<span style="color:#f92672">&gt;</span>, Option<span style="color:#f92672">&lt;</span>Box<span style="color:#f92672">&lt;</span>Stmt<span style="color:#f92672">&gt;&gt;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... every other kind of statement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>The same can be done for other constructs, essentially mindlessly.</p>
<h3 id="ir-generation">IR Generation<a hidden class="anchor" aria-hidden="true" href="#ir-generation">#</a></h3>
<p>This is really where the magic happens. But before discussing the code generation process, it&rsquo;s important to consider what the IR will look like. Our IR language must account for the fact that Brainfuck does not have random access memory, and so every decision about where we store each value will create tangible, difficult obstacles when we try to translate into Brainfuck.</p>
<p>This is a bit of a puzzle that I encourage you to consider. Noticing a solution for this problem is what inspired me to work on this project at all.</p>
<p>The idea is to use a <a href="https://en.wikipedia.org/wiki/Stack-oriented_programming">stack-based</a> IR. What this means is that our instructions will not take any arguments, and we will instead operate on a single stack. This way, when we translate to Brainfuck, we will (for the most part) not have any arguments to retrieve from memory.</p>
<p>For example, consider the statement:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">putchar</span>(<span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>);
</span></span></code></pre></div><p>Using a register-based IR, for example, might yield something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r0</span>, <span style="color:#ae81ff">48</span>     <span style="color:#75715e">; 48 is &#39;0&#39; in ASCII
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r2</span>, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mul</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r2</span> <span style="color:#75715e">; multiply r1 &amp; r2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r0</span>, <span style="color:#66d9ef">r0</span>, <span style="color:#66d9ef">r1</span> <span style="color:#75715e">; add r1 to r0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">putchar</span> <span style="color:#66d9ef">r0</span>     <span style="color:#75715e">; ... or whatever the I/O convention is
</span></span></span></code></pre></div><p>But our stack-based IR has no (non-constant) arguments at all. Instead, each argument acts on the outputs of the previous ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Push</span>(<span style="color:#ae81ff">48</span>) <span style="color:#75715e">; stack becomes [48]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Push</span>(<span style="color:#ae81ff">3</span>)  <span style="color:#75715e">; stack becomes [48, 3]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Push</span>(<span style="color:#ae81ff">2</span>)  <span style="color:#75715e">; stack becomes [48, 3, 2]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Mul</span>      <span style="color:#75715e">; stack becomes [48, 6]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Add</span>      <span style="color:#75715e">; stack becomes [54]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">PutChar</span>  <span style="color:#75715e">; stack becomes []
</span></span></span></code></pre></div><p>Staying with our if-statement example from earlier, the AST node <code>If(cond, then, else)</code> would become something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#75715e">; [IR for `cond`]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Branch</span>(<span style="color:#66d9ef">L1</span>, <span style="color:#66d9ef">L2</span>) <span style="color:#75715e">; Jump to L1 if cond is true, L2 otherwise
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Label</span>(<span style="color:#66d9ef">L1</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">; [IR for `then`]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">GoTo</span>(<span style="color:#66d9ef">L3</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Label</span>(<span style="color:#66d9ef">L2</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">; [IR for `else`]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Label</span>(<span style="color:#66d9ef">L3</span>)
</span></span></code></pre></div><p>Notice that, while these instructions take arguments, they are all constants. We never have to read any memory apart from the values at the top of the stack.</p>
<h3 id="translation-into-brainfuck">Translation into Brainfuck<a hidden class="anchor" aria-hidden="true" href="#translation-into-brainfuck">#</a></h3>
<p>The stack-based IR is especially nice because Brainfuck&rsquo;s semantics basically provide us with a stack already, in the form of its tape. We can think of the tape head as pointing to the top of the stack and the cells to the head&rsquo;s left as the values on the stack. We should be careful to keep cells to the right of the tape head empty, so that we can use those cells as-needed. With this approach, translating our first few instructions is a breeze. For example:</p>
<ol>
<li><code>Push(5)</code>: <code>&gt;+++++</code><br>
We just move the tape head and increment the new cell 5 times.</li>
<li><code>Add</code>: <code>[-&lt;+&gt;]&lt;</code><br>
Slightly more complicated, but not too bad. If <code>x</code> &amp; <code>y</code> are our arguments, we repeatedly decrement <code>x</code> &amp; increment <code>y</code>, until <code>x</code> is zero. Then, we shift the head back one cell to free a space on the stack.</li>
<li><code>Store(3)</code>: <code>&lt;&lt;&lt;[-]&gt;&gt;&gt;[-&lt;&lt;&lt;+&gt;&gt;&gt;]&lt;</code><br>
To move a value from the top of the stack to a slot further down, we just clear that slot, then add the value at the top of the stack, and then move the tape head back.</li>
<li><code>GoTo</code>: Hm&hellip; While arithmetic and other basic operations can be implemented by direct translations<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>, implementing the jumping we need for general control flow (or for function pointers) is more complicated.</li>
</ol>
<p>Again, I encourage you to stop and think through this. This is another puzzle.</p>
<p>This time, the idea is to use a whole-program transformation. We can wrap the whole program in a <code>[</code>/<code>]</code> loop, and then gate each block of assembly in an if-statement. This way, we only need to implement one simple kind of control flow in Brainfuck. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>a:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Block A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">goto</span> c;
</span></span><span style="display:flex;"><span>b:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Block B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>();
</span></span><span style="display:flex;"><span>c:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Block C
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">goto</span> b;
</span></span></code></pre></div><p>&hellip; can be rewritten as &hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (label <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (label <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;a&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Block A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;c&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (label <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;b&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Block B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    label <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (label <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;c&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Block C
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;b&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Implementing equality checks, while-non-zero loops, and if-statements in Brainfuck are all, if not easy problems, at least tractable ones.</p>
<p>As for pointer-reads-and-writes, I will make no attempt to explain these, beyond linking <a href="https://www.inshame.com/2008/02/efficient-brainfuck-tables.html">this excellent article</a>.</p>
<p>I&rsquo;ve skipped over all sorts of caveats and minutiae, for example, the details of our calling convention and how we access global variables from inside function calls. This has been to everyone&rsquo;s benefit.</p>
<h3 id="peephole-optimization">Peephole optimization<a hidden class="anchor" aria-hidden="true" href="#peephole-optimization">#</a></h3>
<p>While the above steps do let us compile working Brainfuck programs, they aren&rsquo;t close to optimal. Just looking at a snippet of our donut.bf code, we see all sorts of suboptimal code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-brainfuck" data-lang="brainfuck"><span style="display:flex;"><span>+&lt;<span style="color:#66d9ef">[[</span>-<span style="color:#66d9ef">]</span>&gt;-&lt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;+&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&lt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>&lt;&gt;&gt;+&gt;+++++++++++++++<span style="color:#66d9ef">[</span>-&lt;<span style="color:#66d9ef">[</span>-&gt;&gt;+&gt;+&lt;&lt;&lt;<span style="color:#66d9ef">]</span>&gt;&gt;<span style="color:#66d9ef">[</span>-&lt;&lt;<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>+&gt;&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;&lt;&lt;+&gt;&gt;&gt;<span style="color:#66d9ef">]</span>&lt;&lt;<span style="color:#66d9ef">]</span>&lt;&lt;&lt;<span style="color:#66d9ef">[</span>-&gt;&gt;&gt;+&gt;+&lt;&lt;&lt;&lt;<span style="color:#66d9ef">]</span>&gt;&gt;&gt;&gt;<span style="color:#66d9ef">[</span>-&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;<span style="color:#66d9ef">]</span>&lt;&gt;&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>--<span style="color:#66d9ef">[</span>++++<span style="color:#66d9ef">[</span>-&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">]</span>++&lt;<span style="color:#66d9ef">]</span>&gt;--&lt;&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&gt;+&lt;<span style="color:#66d9ef">]</span>&gt;&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>+&gt;<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>+&gt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>--<span style="color:#66d9ef">[</span>++++<span style="color:#66d9ef">[</span>-&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">]</span>++&lt;<span style="color:#66d9ef">]</span>&gt;--&lt;&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">]</span>&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>++++<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>++++++++++++<span style="color:#66d9ef">[</span>-&lt;<span style="color:#66d9ef">[</span>-&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;+&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>&lt;+&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>&gt;+&lt;----<span style="color:#66d9ef">[[</span>-<span style="color:#66d9ef">]</span>&gt;-&lt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&lt;+&gt;&gt;+&lt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;+&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">]</span>&lt;&lt;<span style="color:#66d9ef">[</span>&lt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&gt;<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>++&lt;<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;+&gt;<span style="color:#66d9ef">]</span>&gt;&gt;<span style="color:#66d9ef">[</span>&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">]</span>&lt;&lt;&lt;&lt;<span style="color:#66d9ef">[</span>-<span style="color:#66d9ef">]</span>&gt;<span style="color:#66d9ef">[</span>-&lt;+&gt;<span style="color:#66d9ef">]</span>&lt;<span style="color:#66d9ef">[</span>-&gt;+&gt;+&lt;&lt;<span style="color:#66d9ef">]</span>&gt;&gt;<span style="color:#66d9ef">[</span>-&lt;&lt;+&gt;&gt;<span style="color:#66d9ef">]</span>&lt;&gt;++++++++++<span style="color:#75715e">
</span></span></span></code></pre></div><p>All over the place, we see sequences like <code>&lt;&gt;</code> or <code>&gt;&lt;</code>, which can be eliminated entirely. Even worse, we also find slow  <em>but optimal</em> code, such as long strings of <code>&gt;</code>/<code>&lt;</code> &amp; <code>+</code>/<code>-</code> instructions, <code>[-]</code> sections, and &ldquo;move&rdquo; blocks (i.e., blocks which clear a cell and add or subtract its value from other cells, such as <code>[-&lt;+&gt;]</code> or <code>[-&gt;&gt;+&gt;+&lt;&lt;&lt;]</code>).</p>
<p>These are not hard to detect, and doing so allows us to skip-ahead and execute large blocks at a time in one fell swoop. Doing so speeds up our code massively. For example, adding 100 to 100 would normally take about 600 instructions, but instead becomes a single instruction.</p>
<p>I tried rendering a single frame of donut.c without these optimizations, but gave up after about 20 hours because my laptop started to overheat so much that my screen became unresponsive. Some back-of-the-napkin math shows I could have expected to wait about 6 more hours on my machine.</p>
<p>With these optimizations, we can render a frame in about 90 minutes.</p>
<p>We can take this even further though, because some profiling reveals that only a small number of complex instructions take up almost all of our runtime. After using a similar trick to detect the code I generate for complex instructions like bitwise operations, multiplications, divisions, and memory accesses (effectively decompiling them back into IR at runtime), I can render a frame in about 12 minutes.<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>
<p>Yes, this last trick is kind of cheating. No, I don&rsquo;t really care.</p>
<h2 id="limitations">Limitations<a hidden class="anchor" aria-hidden="true" href="#limitations">#</a></h2>
<p>There are some features missing, but for the most part, they would not be hard to add. The limiting factor was just that around this point, this project went from fun and educational to time-consuming and tedious.</p>
<p>Some major missing features are:</p>
<ul>
<li>Support for variadic functions (including <code>printf</code>).</li>
<li>Standard library functions more generally.</li>
<li>Differently-sized types (apart from arrays). Most Brainfuck interpreters use 1-byte cells. Mine uses 2-byte cells so they are large enough to store the labels to be jumped to, and so that I could have enough precision to implement usable fixed-point arithmetic.</li>
<li><code>switch</code> statements. No excuse here, just got a bit lazy.</li>
<li>Memory allocation / variable length arrays. This would be a complicated addition to make, since we would have to change how we access global variables, but it would not be far out of reach.</li>
</ul>
<h2 id="similar-projects">Similar Projects<a hidden class="anchor" aria-hidden="true" href="#similar-projects">#</a></h2>
<p>After completing this project and doing some research, I found that the idea for this project, like any good idea, has been had several times before. However, while I definitely commend anyone who takes on the important work of building an X-to-Brainfuck compiler, I do think my approach sets this project apart from others.</p>
<p>Several projects (such as the one described <a href="https://www.bozidarevic.com/2019/12/transpiling-c-into-brainfuck/">here</a>) exist which can translate simple commands, and even loops, but do not support things like function calls. The linked article even goes so far as to describe the jumping trick I used, but says it&rsquo;d be too difficult to implement.</p>
<p>The only ones I&rsquo;ve found which are as complete as mine are ones which do work, but are more like emulators written in Brainfuck than transpilers. That is, rather than translate the code directly, they act like virtual machines, putting instructions into memory and then executing each one independently, simulating traditional memory and registers. <a href="https://github.com/shinh/elvm">ELVM</a> is a project which targets many esolangs, but the BF implementation is essentially an emulator. Gregor Richards has <a href="https://esolangs.org/wiki/C2BF">another project</a> which is explicitly an emulator.</p>
<p>There&rsquo;s nothing wrong with emulators, but I feel my approach gives more of a &ldquo;true&rdquo; translation (whatever that means), and the stack-based IR really is the secret ingredient for that. It&rsquo;s probably also much faster, since we just need to actually execute each instruction, as opposed to loading instructions from memory and dealing with program counters and registers and so on. I didn&rsquo;t benchmark them though, because my implementation is written in Rust, so no matter how slow it is, it&rsquo;s still blazingly fast.</p>
<p>So go forth, prosper, and put Brainfuck in production ;)</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>With a little help from <a href="https://esolangs.org/wiki/P%27%27">Bohm</a>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>I would highly encourage anyone who hasn&rsquo;t done so to take a good, hard look at the C grammar, or at least to peruse the Microsoft C reference (or the C Standard, though this is not for the faint of heart). C is full of interesting quirks that you might otherwise never encounter, and if there&rsquo;s one thing building a compiler forces you to do, it&rsquo;s to really, <em>really</em> learn your language.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>&ldquo;Direct&rdquo; does not mean &ldquo;simple&rdquo;; just try implementing bitwise operations without multiplication or division. Even unsigned comparisons are highly nontrivial. If you&rsquo;re interested, take a look at <a href="https://esolangs.org/wiki/Brainfuck_algorithms">these</a> for inspiration.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>In order to be able to do this safely, we have to be sure that whenever we see the code for a bitwise operation (for example), it truly does just compute value, with no side effects. This means we have to be sure that all memory cells that that snippet of code could read have the values we expect. We can do this by having these instructions clear all the memory they need before using any of it.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul><div class="ml-embedded" data-form="hp55Js"></div>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/projects/synthesizer/">
    <span class="title">Next »</span>
    <br>
    <span>Building a Program Synthesizer</span>
  </a>
</nav>


  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">iacgm</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
